<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p>1.拉取docker 镜像    </p>
<pre><code>docker pull mukever/opencap:v0.1</code></pre><p>2.启动镜像</p>
<pre><code>sudo docker run --ipc=host -p 8888:8888 --name opencap opencap:v0.1 jupyter notebook  --ip=0.0.0.0  --no-browser  --allow-root </code></pre><p>3.docker镜像中已经存放了模型，可以自行使用。 可以识别10个字符以内的中英验证码。验证码输出为大写，对大小写不敏感。</p>
<p>4.有兴趣的朋友，可以star。</p>
<pre><code class="python">%matplotlib notebook
<span class="comment"># import d2lzh as d2l</span>
<span class="keyword">from</span> PIL <span class="keyword">import</span> Image
<span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt
<span class="keyword">import</span> matplotlib.image <span class="keyword">as</span> mpimg</code></pre>
<pre><code class="python">! ls -al models/caffemodel
! pwd</code></pre>
<pre><code>total 44512
drwxr-xr-x 2 root root     4096 Nov  3 14:59 .
drwxr-xr-x 3 root root     4096 Nov  3 14:49 ..
-rw-r--r-- 1 root root 45535232 Oct 12 06:50 caffe.caffemodel
-rw-r--r-- 1 root root    20754 Oct 12 06:50 deploy.prototxt
-rw-r--r-- 1 root root     6148 Nov  3 15:01 .DS_Store
-rw-r--r-- 1 root root       73 Oct 12 06:50 label-map.txt
/</code></pre><pre><code class="python"><span class="keyword">import</span> os
<span class="keyword">import</span> caffe
caffe.set_mode_cpu()
<span class="keyword">import</span> numpy <span class="keyword">as</span> np
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(<span class="string">'__file__'</span>)))
deploy = os.path.join(BASE_DIR, <span class="string">'models/caffemodel/deploy.prototxt'</span>)  <span class="comment"># deploy文件</span>
caffe_model = os.path.join(BASE_DIR, <span class="string">'models/caffemodel/caffe.caffemodel'</span>)  <span class="comment"># 训练好的 caffemodel</span>
labels_filename = os.path.join(BASE_DIR, <span class="string">'models/caffemodel/label-map.txt'</span>)  <span class="comment"># 类别名称文件，将数字标签转换回类别名称</span>
LABELS = np.loadtxt(labels_filename, str, delimiter=<span class="string">'\n'</span>)   <span class="comment">#读取类别名称文件</span>
CAFFENET = caffe.Net(deploy, caffe_model, caffe.TEST)  <span class="comment"># 加载model和network</span>

<span class="comment"># 图片预处理设置</span>
Transformer = caffe.io.Transformer({<span class="string">'data'</span>: CAFFENET.blobs[<span class="string">'data'</span>].data.shape})  <span class="comment"># 设定图片的shape格式(1,3,28,28)</span>
Transformer.set_transpose(<span class="string">'data'</span>, (<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>))  <span class="comment"># 改变维度的顺序，由原始图片(28,28,3)变为(3,28,28)</span>
Transformer.set_mean(<span class="string">'data'</span>, np.array([<span class="number">104</span>, <span class="number">117</span>, <span class="number">123</span>]))  <span class="comment"># 减去均值，前面训练模型时没有减均值，这儿就不用</span>
Transformer.set_raw_scale(<span class="string">'data'</span>, <span class="number">255</span>)  <span class="comment"># 缩放到【0，255】之间</span>
Transformer.set_channel_swap(<span class="string">'data'</span>, (<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>))  <span class="comment"># 交换通道，将图片由RGB变为BGR</span>
</code></pre>
<pre><code class="python">! rm -rf TEST/.DS_Store</code></pre>
<pre><code class="python">TEST_IMG_PATH = <span class="string">'TEST'</span>
</code></pre>
<pre><code class="python">image_files_list = os.listdir(TEST_IMG_PATH)
<span class="keyword">for</span> image_file_name <span class="keyword">in</span> image_files_list:
    im = caffe.io.load_image(os.path.join(TEST_IMG_PATH,image_file_name))  <span class="comment"># 加载图片</span>
    <span class="comment">### detail</span>
    CAFFENET.blobs[<span class="string">'data'</span>].data[...] = Transformer.preprocess(<span class="string">'data'</span>, im)  <span class="comment"># 执行上面设置的图片预处理操作，并将图片载入到blob中</span>
    <span class="comment">### predict</span>
    CAFFENET.forward()
    Predisct = <span class="string">""</span>
    pre_st = <span class="number">0</span>
    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">11</span>):
        <span class="comment"># print('---------------------\n',net.blobs['fc1000'+str(i)].data)</span>
        prob = CAFFENET.blobs[<span class="string">'fc1000'</span> + str(i)].data[<span class="number">0</span>].flatten()  <span class="comment"># 取出最后一层（Softmax）属于某个类别的概率值，并打印</span>
        <span class="comment"># print (prob)</span>
        order = prob.argsort()[<span class="number">-1</span>]  <span class="comment"># 将概率值排序，取出最大值所在的序号</span>
        <span class="comment"># print(order)</span>
        Predisct+=LABELS[order]  <span class="comment"># 将该序号转换成对应的类别名称，并打印</span>
    image = Image.open(os.path.join(TEST_IMG_PATH,image_file_name))
    print(Predisct)
    display(image)</code></pre>
<pre><code>79RG------</code></pre><p><img src="output_6_1.png" alt="png"></p>
<pre><code>NGEF------</code></pre><p><img src="output_6_3.png" alt="png"></p>
<pre><code>YQ8V------</code></pre><p><img src="output_6_5.png" alt="png"></p>
<pre><code>GGFK------</code></pre><p><img src="output_6_7.png" alt="png"></p>
<pre><code>QNKKD-----</code></pre><p><img src="output_6_9.png" alt="png"></p>
<pre><code>N8SE------</code></pre><p><img src="output_6_11.png" alt="png"></p>
